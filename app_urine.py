import streamlit as st
from docxtpl import DocxTemplate
from datetime import datetime
import io

st.set_page_config(page_title="‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏£‡∏ß‡∏à‡∏õ‡∏±‡∏™‡∏™‡∏≤‡∏ß‡∏∞", page_icon="üß™")

st.title("üß™ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏£‡∏ß‡∏à‡∏õ‡∏±‡∏™‡∏™‡∏≤‡∏ß‡∏∞ (‡∏™‡∏†.‡∏´‡∏ô‡∏≠‡∏á‡∏´‡∏ç‡πâ‡∏≤‡πÑ‡∏ã)")
st.info("‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ Word")

# --- 1. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ ---
with st.expander("1. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à (‡πÄ‡∏ß‡∏•‡∏≤/‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà/‡∏ú‡∏π‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡∏£‡∏ß‡∏à)", expanded=True):
    col1, col2 = st.columns(2)
    with col1:
        record_date = st.date_input("‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à", datetime.now())
        record_time = st.time_input("‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Å‡πá‡∏ö‡∏õ‡∏±‡∏™‡∏™‡∏≤‡∏ß‡∏∞ (‡∏ô.)")
        location = st.text_area("‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à", "‡∏™‡∏†.‡∏´‡∏ô‡∏≠‡∏á‡∏´‡∏ç‡πâ‡∏≤‡πÑ‡∏ã ‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà 5 ‡∏ï.‡∏´‡∏ô‡∏≠‡∏á‡∏´‡∏ç‡πâ‡∏≤‡πÑ‡∏ã ‡∏≠.‡∏´‡∏ô‡∏≠‡∏á‡∏´‡∏ç‡πâ‡∏≤‡πÑ‡∏ã ‡∏à.‡∏™‡∏∏‡∏û‡∏£‡∏£‡∏ì‡∏ö‡∏∏‡∏£‡∏µ")
    with col2:
        suspect_name = st.text_input("‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏• ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à", "‡∏ô‡∏≤‡∏¢‡∏ä‡∏ß‡∏Å‡∏£ ‡∏®‡∏£‡∏µ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡πå")
        age = st.number_input("‡∏≠‡∏≤‡∏¢‡∏∏ (‡∏õ‡∏µ)", 15, 100, 22)
        id_card = st.text_input("‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô", "1-xxxx-xxxxx-xx-x")
        address = st.text_area("‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô", "4 ‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà 1 ‡∏ï.‡∏´‡∏ô‡∏≠‡∏á‡πÇ‡∏û‡∏ò‡∏¥‡πå ‡∏≠.‡∏´‡∏ô‡∏≠‡∏á‡∏´‡∏ç‡πâ‡∏≤‡πÑ‡∏ã ‡∏à.‡∏™‡∏∏‡∏û‡∏£‡∏£‡∏ì‡∏ö‡∏∏‡∏£‡∏µ")

# --- 2. ‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å) ---
with st.expander("2. ‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡∏Ñ‡∏ô‡πÄ‡∏ã‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏£‡∏Å)", expanded=True):
    c1, c2 = st.columns([1, 3])
    rank_1 = c1.text_input("‡∏¢‡∏® (‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å)", "‡∏£.‡∏ï.‡∏ó.")
    name_1 = c2.text_input("‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏• (‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å)", "‡∏ß‡∏¥‡πÄ‡∏ä‡∏µ‡∏¢‡∏£ ‡∏™‡∏∏‡∏û‡∏£‡∏£‡∏ì‡πÇ‡∏û‡∏ò‡∏¥‡πå‡∏ó‡∏≠‡∏á")

# --- 3. ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à ---
with st.expander("3. ‡∏ä‡∏∏‡∏î‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à", expanded=True):
    st.write("ü¶† **‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏≤‡∏£‡πÄ‡∏™‡∏û‡∏ï‡∏¥‡∏î‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à:**")
    drug_type = st.radio("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏ô‡∏¥‡∏î‡∏™‡∏≤‡∏£‡πÄ‡∏™‡∏û‡∏ï‡∏¥‡∏î", ["‡πÄ‡∏°‡∏ó‡πÅ‡∏≠‡∏°‡πÄ‡∏ü‡∏ï‡∏≤‡∏°‡∏µ‡∏ô (‡∏¢‡∏≤‡∏ö‡πâ‡∏≤)", "‡∏Å‡∏±‡∏ç‡∏ä‡∏≤", "‡∏≠‡∏∑‡πà‡∏ô‡πÜ"])
    
    other_kit = ""
    if drug_type == "‡∏≠‡∏∑‡πà‡∏ô‡πÜ":
        other_kit = st.text_input("‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£/‡∏ä‡∏∏‡∏î‡∏ï‡∏£‡∏ß‡∏à")

    st.markdown("---")
    st.write("üìä **‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô:**")
    result = st.radio("‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à", ["‡∏ú‡∏•‡∏•‡∏ö (‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏≤‡∏£)", "‡∏ú‡∏•‡∏ö‡∏ß‡∏Å (‡∏û‡∏ö‡∏™‡∏≤‡∏£‡πÄ‡∏™‡∏û‡∏ï‡∏¥‡∏î)"])

# --- 4. ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏ï‡∏£‡∏ß‡∏à (‡∏Ñ‡∏ô‡πÄ‡∏ã‡πá‡∏ô‡∏ó‡πâ‡∏≤‡∏¢‡∏™‡∏∏‡∏î) ---
with st.expander("4. ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à (‡∏û‡∏¢‡∏≤‡∏ô/‡∏Ñ‡∏ô‡πÄ‡∏ã‡πá‡∏ô‡∏ó‡πâ‡∏≤‡∏¢)", expanded=True):
    c3, c4 = st.columns([1, 3])
    rank_2 = c3.text_input("‡∏¢‡∏® (‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢)", "‡∏£.‡∏ï.‡∏ï.")
    name_2 = c4.text_input("‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏• (‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢)", "‡∏≠‡∏≥‡∏ô‡∏≤‡∏à ‡∏Ç‡∏±‡∏ô‡∏ó‡∏™‡∏¥‡∏Å‡∏£‡∏£‡∏°")

# --- ‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• ---
st.markdown("---")
if st.button("üñ®Ô∏è ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏£‡∏ß‡∏à‡∏õ‡∏±‡∏™‡∏™‡∏≤‡∏ß‡∏∞ (Word)", type="primary"):
    try:
        # ‡πÇ‡∏´‡∏•‡∏î Template (‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏∑‡πà‡∏≠ template_urine.docx)
        doc = DocxTemplate("template_urine.docx")
        
        # ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏ó‡∏¢
        thai_months = ["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô", 
                       "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"]
        d = record_date.day
        m = thai_months[record_date.month - 1]
        y = record_date.year + 543
        date_thai = f"{d}  ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô  {m}  ‡∏û.‡∏®.  {y}"
        
        # Logic ‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏ñ‡∏π‡∏Å (‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ "X" ‡∏´‡∏£‡∏∑‡∏≠ "/" ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏ñ‡∏π‡∏Å)
        CHECK = "/"  
        
        context = {
            'location': location,
            'date_thai': date_thai,
            'time': record_time.strftime("%H:%M"),
            'suspect_name': suspect_name,
            'age': age,
            'id_card': id_card,
            'address': address,
            
            # ‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà 1
            'rank_1': rank_1,
            'name_1': name_1,
            
            # ‡∏ï‡∏¥‡πä‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ä‡∏∏‡∏î‡∏ï‡∏£‡∏ß‡∏à
            'c_meth': CHECK if drug_type == "‡πÄ‡∏°‡∏ó‡πÅ‡∏≠‡∏°‡πÄ‡∏ü‡∏ï‡∏≤‡∏°‡∏µ‡∏ô (‡∏¢‡∏≤‡∏ö‡πâ‡∏≤)" else " ",
            'c_weed': CHECK if drug_type == "‡∏Å‡∏±‡∏ç‡∏ä‡∏≤" else " ",
            'c_other': CHECK if drug_type == "‡∏≠‡∏∑‡πà‡∏ô‡πÜ" else " ",
            'other_kit': other_kit,
            
            # ‡∏ï‡∏¥‡πä‡∏Å‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à (‡∏™‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏°)
            'r_neg': CHECK if "‡∏ú‡∏•‡∏•‡∏ö" in result else " ",
            'r_pos': CHECK if "‡∏ú‡∏•‡∏ö‡∏ß‡∏Å" in result else " ",
            
            # ‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà 2
            'rank_2': rank_2,
            'name_2': name_2
        }
        
        doc.render(context)
        
        bio = io.BytesIO()
        doc.save(bio)
        
        st.success("‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏£‡∏ß‡∏à‡∏õ‡∏±‡∏™‡∏™‡∏≤‡∏ß‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!")
        st.download_button(
            label="‚¨áÔ∏è ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Word",
            data=bio.getvalue(),
            file_name=f"‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏â‡∏µ‡πà_{suspect_name}.docx",
            mime="application/vnd.openxmlformats-officedocument.wordprocessingml.document"
        )
                
    except Exception as e:
        st.error(f"‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: {e}")

        st.warning("‚ö†Ô∏è ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå template_urine.docx ‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ {{ }} ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö")

